language: go
sudo: required
services: docker

go:
  - 1.12.x

go_import_path: github.com/appsody/appsody

# skip the default language's install and script steps, we implement job stages instead
install: skip
script: skip

stages:
  - name: lint
  - name: test
  - name: deploy
    if: branch = master AND tag IS present

test-stage-template: &test-stage-template
  stage: test
  install:
    - wget https://github.com/appsody/controller/releases/download/0.2.1/appsody-controller
    - chmod +x appsody-controller
    - mkdir ~/.appsody
    - cp appsody-controller ~/.appsody/
    - if [ "$TRAVIS_OS_NAME" = "windows" ]; then choco install make; fi
  script:
    - systeminfo #| findstr OS
    - docker version
    - Powershell -Command "Stop-Service docker"
    - net stop docker
    - docker version
    # - Powershell -Command Get-VM # does not work, must not have administrator
    #- Powershell -Command Get-ChildItem -Path Env:\
    - choco install docker-desktop
    - refreshenv
    - docker version
    # Enable linux docker https://blog.docker.com/2017/09/docker-windows-server-1709/
    # - Powershell -Command "Import-Module PackageManagement"
    # - Powershell -Command "Import-Module PowerShellGet"
    # - Powershell -Command "Uninstall-Package -Name docker -ProviderName DockerProvider"
    # - Powershell -Command "Install-Module DockerProvider"
    # - Powershell -Command "Install-Package Docker -ProviderName DockerProvider -RequiredVersion preview"
    # - Powershell -Command "[Environment]::GetEnvironmentVariable('LCOW_SUPPORTED', 'Machine')"
    # - Powershell -Command "[Environment]::SetEnvironmentVariable('LCOW_SUPPORTED', '1', 'Machine')"
    # - Powershell -Command "[Environment]::GetEnvironmentVariable('LCOW_SUPPORTED', 'Machine')"
    # - Powershell -Command Restart-Service Docker
    # - Powershell -Command Docker version
    # - Powershell -Command Docker pull appsody/nodejs-express:0.2
    # - cd
    # - dir
    # - cd "\Program Files\Docker"
    # - dir
    # - dockerd.exe -SwitchDaemon
    # - docker.exe -SwitchDaemon
    - cd "\Program Files\Docker\Docker\"
    - dir
    - DockerCli.exe -SwitchDaemon
    - docker pull appsody/nodejs-express:0.2
      
jobs:
  include:
    - name: Lint
      stage: lint
      os: linux
      script: make lint
    - <<: *test-stage-template
      name: Test on Linux
      os: linux
    # - <<: *test-stage-template
    #   name: Test on MacOS
    #   os: osx
    - <<: *test-stage-template
      name: Test on Windows
      os: windows
    - name: Deploy Release
      stage: deploy
      os: linux
      script:
        - make VERSION=${TRAVIS_TAG}  package
        - make deploy
      deploy:
        provider: releases
        skip_cleanup: true
        api_key:
          secure: gtGyAu3m2v26KtkzQu4ljkLGLGKpCJAak0cO00zlvDvEGxwqmiH7yytG8uoAOise8Fp/1pF5YXrhpw6I7+WN1s8k+GJyCKoLG60wf9ODF4BR+9vGiwOfObs91yAfKz4oA/zzGG2eLdD59Y4VoRgY46OzsmGDbw9Zf34r+xGQ3fdrQCYbLItJzLwX/GEfWGBtVmJVb+BIuFrZ0UF1zTswC8+TkPDj/u+Pnc5bMXUqH7gUz2wrVdDc873EJjILB6U8iMIrFrKshr1CQ/C4JTJh7l6xiCJ5NS8Ik40jYrVfytMHo9cC93VkUnl1fNJuBo7kRQAbek1Jp7gmsfX1BQzmXp6p+VpgQmealqDWa+b25VhBS7T0Bz3nZvktAdRE6kbpVYgbS/YpDEQWNLaMreezd9taYjDFz+k3PlNCsMqPGfyU4jV1VViHuyFJvBuIt3JlHOm3mF/bNIdfDLVtkugl/etBoyITD0Gths+xNh997ctB9diGhlwmu3VkMEo173aEtYjpNPLQrkAFtA0476xLIJroPb4R2KlO31iC5tpUU9Ge/65ZUPaMaDIgR8kcLGmKvAdNwdDonZguT8Q/XlEPpn0MCmKbZcX2/G3l3+Sc2YN7EHeH1t7gGbQAjzHzsQCHLCCbL2p8X/AJzf6vQJRI1kEEs9QFwLg7vBjjT2n6Nzg=
        file: package/*
        file_glob: true
        on:
          branch: master
          condition: $TRAVIS_OS_NAME = linux
          tags: true




    